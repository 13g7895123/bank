# 銀行財報系統 - 當前狀態報告

> 更新日期：2025-11-30 11:50（修復 05 華南、06 彰化、07 上海銀行）

## 系統概覽

| 項目 | 數量/狀態 |
|------|-----------|
| 支援銀行數 | 38 家 |
| 下載器數量 | 38 個 |
| 業務類別 | 8 種 |
| 核心模組 | 已重構 ✅ |
| OCR 支援 | 已實作 ✅ |
| 無頭模式自動切換 | 已實作 ✅ |

## 功能狀態

### 1. 下載功能 (Downloader)

使用 Playwright 進行網頁自動化下載銀行財報 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | 下載功能正常 |
| ⚠️ 無資料 | 該季度尚無資料或網站僅保留近期資料 |
| ❌ 錯誤 | 下載失敗（Timeout/環境問題） |

**下載方式統計**：
| 方式 | 數量 | 說明 |
|------|------|------|
| URL 直接下載 | 31 家 | `download_pdf_from_url` |
| 點擊下載 | 4 家 | `expect_download` |
| 特殊處理 | 3 家 | GraphQL API / JavaScript |

**無頭/有頭模式**：
- 預設使用無頭模式
- 下載後自動驗證 PDF 檔案
- 驗證失敗時自動切換有頭模式重試

### 2. 解析功能 (Parser)

使用 pdfplumber 解析 PDF 並提取資產品質資料。

| 狀態 | 說明 |
|------|------|
| ✅ 完整 | 8/8 類別全部解析成功 |
| ⚠️ 部分 | 解析成功但缺少部分類別 |
| ❌ 失敗 | 無法解析（PDF 格式特殊） |

### 3. OCR 功能

使用 Tesseract OCR 處理掃描式 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | OCR 解析器已實作 |
| ⚠️ 部分 | 受 PDF 品質影響，部分類別無法辨識 |

---

## 各銀行狀態明細

> 更新日期：2025-11-30 11:25

| 代碼 | 銀行名稱 | 113Q4 下載 | 113Q4 解析 | 114Q1 下載 | 114Q1 解析 | 備註 |
|------|----------|------------|------------|------------|------------|------|
| 01 | 臺灣銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 02 | 臺灣土地銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 03 | 合作金庫商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 04 | 第一商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx，強制有頭模式 |
| 05 | 華南商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx，新增年份切換功能 |
| 06 | 彰化商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx，Q4對應年度資料 |
| 07 | 上海商業儲蓄銀行 | ✅ | ✅ 8/8 | ✅ | ❌ 0/8 | 已輸出 xlsx (僅113Q4)，114Q1 PDF格式特殊 |
| 08 | 台北富邦銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 09 | 國泰世華商業銀行 | ❌ Timeout | - | ❌ Timeout | - | 無頭模式 Timeout |
| 10 | 中國輸出入銀行 | ✅ | ⚠️ 3/8 | ✅ | ⚠️ 3/8 | 已輸出 xlsx (政策性銀行，僅3類別) |
| 11 | 高雄銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 12 | 兆豐國際商業銀行 | ✅ | ❌ 0/8 | ✅ | ❌ 0/8 | 下載成功但找不到資產品質頁面 |
| 13 | 花旗（台灣）銀行 | ❌ Timeout | - | ❌ Timeout | - | 無頭模式 Timeout |
| 15 | 王道商業銀行 | ❌ Timeout | - | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 16 | 臺灣中小企業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 17 | 渣打國際商業銀行 | ✅ | ⚠️ 7/8 | ✅ | ⚠️ 7/8 | 已輸出 xlsx (缺1類別) |
| 18 | 台中商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 19 | 京城商業銀行 | ❌ Timeout | - | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 20 | 匯豐(台灣)商業銀行 | ✅ | ✅ 8/8 | ✅ | ❌ 0/8 | 已輸出 xlsx (僅113Q4)，114Q1解析失敗 |
| 21 | 瑞興商業銀行 | ✅ | ❌ 0/8 | ✅ | ❌ 0/8 | 下載成功但找不到資產品質頁面 |
| 22 | 華泰商業銀行 | ⚠️ 無資料 | - | ⚠️ 無資料 | - | 網站無對應季度資料 |
| 23 | 臺灣新光商業銀行 | ✅ | ❌ 0/8 | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 24 | 陽信商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 25 | 板信商業銀行 | ⚠️ 無資料 | - | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 26 | 三信商業銀行 | ⚠️ 無資料 | - | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 27 | 聯邦商業銀行 | ✅ | ❌ 0/8 | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1)，113Q4 PDF格式特殊 |
| 28 | 遠東國際商業銀行 | ⚠️ 無資料 | - | ⚠️ 無資料 | - | 網站無對應季度資料 |
| 29 | 元大商業銀行 | ⚠️ 無資料 | - | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 30 | 永豐商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 31 | 玉山商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 32 | 凱基商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 33 | 星展(台灣)商業銀行 | ✅ | ❌ 0/8 | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1)，113Q4格式特殊 |
| 34 | 台新國際商業銀行 | ⚠️ 無資料 | - | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 36 | 安泰商業銀行 | ⚠️ 無資料 | - | ✅ | ✅ 8/8 | 已輸出 xlsx (僅114Q1) |
| 37 | 中國信託商業銀行 | ✅ | ⚠️ 5/8 | ✅ | ❌ 0/8 | 已輸出 xlsx (僅113Q4 5筆)，114Q1格式特殊 |
| 38 | 樂天國際商業銀行 | ✅ | ✅ 8/8 | ✅ | ✅ 8/8 | 已輸出 xlsx |
| 40 | 連線商業銀行 | ✅ | ✅ 8/8 | ⚠️ 無資料 | - | 已輸出 xlsx (僅113Q4) |
| 41 | 將來商業銀行 | ❌ Timeout | - | ❌ Timeout | - | 無頭模式 Timeout |

> **註**：代碼 14、35、39 無對應銀行

---

## 測試統計 (2025-11-30)

### 113Q4 下載結果

| 狀態 | 數量 | 說明 |
|------|------|------|
| ✅ 成功 | 24 家 | 下載成功 |
| ⚠️ 無資料 | 10 家 | 網站無該季度資料 |
| ❌ 錯誤 | 4 家 | Timeout |

### 114Q1 下載結果

| 狀態 | 數量 | 說明 |
|------|------|------|
| ✅ 成功 | 30 家 | 下載成功 |
| ⚠️ 無資料 | 4 家 | 網站無該季度資料 |
| ❌ 錯誤 | 4 家 | Timeout |

### 解析結果統計

| 狀態 | 113Q4 | 114Q1 |
|------|-------|-------|
| ✅ 完整 (8/8) | 17 家 | 24 家 |
| ⚠️ 部分成功 | 3 家 | 2 家 |
| ❌ 失敗 (0/8) | 4 家 | 4 家 |

### 輸出檔案統計

- 總輸出檔案：32 個 xlsx
- 完整資料 (16筆)：13 家銀行
- 部分資料：19 家銀行

### 無法下載的銀行 (需修復)

| 銀行 | 113Q4 | 114Q1 | 問題 |
|------|-------|-------|------|
| 09 國泰世華 | ❌ | ❌ | Timeout (無頭模式) |
| 13 花旗(台灣) | ❌ | ❌ | Timeout (無頭模式) |
| 41 將來銀行 | ❌ | ❌ | Timeout (無頭模式) |

### 下載成功但解析失敗 (需修復解析器)

| 銀行 | 113Q4 | 114Q1 | 問題 |
|------|-------|-------|------|
| 07 上海商銀 | - | ❌ | 特殊PDF格式 |
| 12 兆豐銀行 | ❌ | ❌ | 找不到資產品質頁面 |
| 20 匯豐銀行 | ✅ | ❌ | 114Q1 格式變更 |
| 21 瑞興銀行 | ❌ | ❌ | 找不到資產品質頁面 |
| 37 中國信託 | ⚠️5/8 | ❌ | 114Q1 格式變更 |

---

## 已知問題與修復記錄

#### 8. 臺灣土地銀行下載器修復 + refactor 路徑修正 (2025-11-30 修復)

**問題描述**：
1. **下載器問題**：原下載器使用 `th` 選擇器尋找年度列，但實際網頁結構使用 `td`
2. **路徑問題**：`cli.py`、`main.py`、`report_generator.py` 使用 `parent.parent` 指向 bank 目錄，應為 refactor 目錄

**表格結構說明**：
- 每兩行為一組：第一行是年度標題+季度標題，第二行是對應的下載連結
- row[0]: td[0]=114年度, td[1]=第一季標題, td[2]=第二季標題...
- row[1]: td[0]=財務報告連結, td[1]=財務報告連結...

**解決方案**：
1. 修正下載器邏輯：
   - 改用 `td` 定位年度列
   - 取得下一行（連結行）的對應季度連結
   - 修改檔案：`banks/bank_02_landbank.py`

2. 修正路徑設定：
   - `cli.py`：`get_base_dir()` 改為 `Path(__file__).parent`
   - `main.py`：`run_report()` 改為 `Path(__file__).parent`
   - `report_generator.py`：`__main__` 區塊改為 `Path(__file__).parent`

**測試結果**：
- 114Q1 下載成功 ✅（1.6 MB）
- PDF 解析成功 8/8 類別 ✅
- 路徑正確指向 refactor/data ✅

#### 7. 臺灣土地銀行下載與解析驗證 (2025-11-30 驗證)

**測試結果**：
- 114Q1 下載成功 ✅（2.2 MB，檔案已存在）
- PDF 解析成功 8/8 類別 ✅

**解析資料摘要**（114Q1）：
| 業務別項目 | 逾期放款(仟元) | 放款總額(仟元) | 逾放比率 |
|------------|---------------|---------------|---------|
| 企業金融_擔保 | 990,933 | 673,930,753 | 0.15% |
| 企業金融_無擔保 | 228,122 | 496,848,569 | 0.05% |
| 消費金融_住宅抵押貸款 | 1,074,313 | 1,163,073,214 | 0.09% |
| 消費金融_現金卡 | 0 | 1,386 | 0.00% |
| 消費金融_小額純信用貸款 | 5,588 | 3,984,597 | 0.14% |
| 消費金融_其他_擔保 | 359,562 | 100,295,538 | 0.36% |
| 消費金融_其他_無擔保 | 13,925 | 26,651,341 | 0.05% |
| 合計 | 2,672,443 | 2,464,785,398 | 0.11% |

#### 5. 臺灣銀行下載器修復 (2025-11-30 修復)

**問題描述**：
- URL 路徑缺少 `/tw`，導致無法正確載入財報頁面
- 匹配字串格式錯誤：多餘空格、使用中文數字而非阿拉伯數字
- 未支援年份切換下拉選單，無法下載 114 年資料

**解決方案**：
- 修正 URL：`/about/...` → `/tw/about/...`
- 修正匹配字串：`個體財務報告 {year}年{quarter_text}` → `個體財務報告{year}年第{quarter}季`
- 修正下載 URL：移除多餘的 `{domain}/` 前綴（link 已是完整 URL）
- 新增年份切換功能：點擊下拉選單切換到指定年份
- 修改位置：`get_Data.py` 第 40-85 行

**測試結果**：
- 113Q4 下載成功 ✅（2.98 MB）
- 114Q1 下載成功 ✅（331 KB）
- PDF 解析成功 8/8 類別 ✅
- 已改用 Playwright 無頭模式（取代 Selenium）✅

#### 6. 臺灣銀行 PDF 解析修復 (2025-11-30 修復)

**問題描述**：
- 114Q1 PDF 表格格式特殊：「企業金融」的「擔保」和「無擔保」在同一欄位，但數據在不同行
- 原解析器無法正確識別「企業金融_無擔保」

**解決方案**：
- 新增 `pending_unsecured` 標記，處理跨行數據
- 當偵測到「企業金融」且 col1 包含「擔保\n無擔保」時，本行為擔保，下一行為無擔保
- 修改位置：`refactor/report_generator.py` 第 165-230 行

### 已修復問題

#### 1. 企業金融類別解析失敗 (2024-11-29 修復)

**問題描述**：
- 6 家銀行的「企業金融_擔保」、「企業金融_無擔保」無法解析
- 原因：PDF 表格中文字格式為 `企 業\n金 融`（有空格和換行）

**影響銀行**：
- 彰化商業銀行、台北富邦銀行、王道商業銀行
- 聯邦商業銀行、玉山商業銀行、台新國際商業銀行

**解決方案**：
- 新增 `normalize_text()` 函數，移除空格和換行後再比對關鍵字
- 修改位置：`report_generator.py` 及 `utils/text.py`

#### 2. 匯豐(台灣)商業銀行下載失敗 (2024-11-29 修復)

**問題描述**：
- 原下載器無法正確找到 114Q1 財報連結
- 搜尋邏輯使用錯誤的 CSS 選擇器

**解決方案**：
- 修改搜尋邏輯，改為搜尋「{西元年}年{季度}重要財務業務資訊」
- 修改位置：`banks/bank_20_hsbc.py`

#### 3. 多家銀行下載器更新 (2024-11-25 ~ 2024-11-29)

已更新下載器的銀行：
- 02 臺灣土地銀行
- 04 第一商業銀行
- 05 華南商業銀行
- 11 高雄銀行
- 12 兆豐國際商業銀行
- 16 臺灣中小企業銀行
- 18 台中商業銀行
- 23 臺灣新光商業銀行
- 24 陽信商業銀行
- 27 聯邦商業銀行
- 30 永豐商業銀行
- 32 凱基商業銀行
- 33 星展(台灣)商業銀行
- 38 樂天國際商業銀行

### 待處理問題

#### 1. 下載錯誤（需修復下載器）- 10 家

| 代碼 | 銀行 | 錯誤類型 | 說明 |
|------|------|----------|------|
| 09 | 國泰世華商業銀行 | Timeout | 網頁載入逾時 |
| 13 | 花旗（台灣）銀行 | Timeout | 網頁載入逾時 |
| 15 | 王道商業銀行 | Timeout | 網頁載入逾時 |
| 16 | 臺灣中小企業銀行 | 環境問題 | 需要 wget 工具 |
| 18 | 台中商業銀行 | Timeout | 網頁載入逾時 |
| 19 | 京城商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 22 | 華泰商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 25 | 板信商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 38 | 樂天國際商業銀行 | 環境問題 | Chromium 路徑問題 |
| 41 | 將來商業銀行 | Timeout | 網頁載入逾時 |

**建議**：
- Timeout 問題：增加 timeout 時間（目前 60 秒），或檢查網站結構是否變更
- 網路錯誤：可能是暫時性網路問題，建議稍後重試
- 環境問題：移除 wget 依賴，統一使用 Playwright；重新安裝 chromium

#### 2. PDF 解析失敗 - 5 家

| 代碼 | 銀行 | 問題 | 建議 |
|------|------|------|------|
| 12 | 兆豐國際商業銀行 | 找不到資產品質頁面 | 分析 PDF 結構 |
| 21 | 瑞興商業銀行 | 掃描式 PDF | 使用 OCR 解析 |
| 23 | 臺灣新光商業銀行 | 找不到資產品質頁面 | 分析 PDF 結構 |
| 27 | 聯邦商業銀行 | PDF Pattern 錯誤 | 處理特殊編碼 |
| 33 | 星展(台灣)商業銀行 | 特殊格式 | 分析 PDF 結構 |

#### 3. 部分解析成功 - 3 家

| 代碼 | 銀行 | 解析結果 | 說明 |
|------|------|----------|------|
| 10 | 中國輸出入銀行 | 3/8 | 政策性銀行，無消費金融 |
| 17 | 渣打國際商業銀行 | 7/8 | 缺少 1 類別 |
| 37 | 中國信託商業銀行 | 5/8 | 缺少 3 類別 |

#### 4. 無資料（非錯誤）- 9 家

這些銀行的 113Q4 資料尚未發布，或網站僅保留近期資料：
- 01 臺灣銀行、05 華南商業銀行、06 彰化商業銀行
- 07 上海商業儲蓄銀行、26 三信商業銀行、28 遠東國際商業銀行
- 29 元大商業銀行、34 台新國際商業銀行、36 安泰商業銀行

**OCR 解析器位置**：`core/ocr_parser.py`

**安裝需求**：
```bash
# macOS
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow
```

---

## 模組結構

```
refactor/
├── core/                    # 核心模組
│   ├── __init__.py
│   ├── models.py            # 資料模型
│   ├── download_manager.py  # 下載管理器
│   ├── report_manager.py    # 報表管理器
│   └── ocr_parser.py        # OCR 解析器（新增）
│
├── banks/                   # 銀行下載器（38 個）
│   ├── base.py              # 基礎類別
│   └── bank_XX_xxx.py       # 各銀行實作
│
├── utils/                   # 工具模組
│   ├── __init__.py
│   ├── text.py              # 文字處理
│   ├── date.py              # 日期處理
│   └── file.py              # 檔案處理
│
├── docs/                    # 文件
│   ├── DOWNLOADER_AUDIT.md  # 下載器盤點報告
│   └── *.md                 # 調查報告
│
├── tests/                   # 測試工具
│   ├── diagnose_failed_banks.py
│   └── test_all.py
│
├── downloader.py            # 下載器主模組
├── report_generator.py      # 報表生成器
├── cli.py                   # 互動式介面
├── main.py                  # 命令列主程式
├── ARCHITECTURE.md          # 架構說明
└── STATUS.md                # 狀態說明（本文件）
```

---

## 測試結果 (114Q1)

### 下載測試

| 項目 | 結果 |
|------|------|
| 測試銀行數 | 38 家 |
| 成功下載 | 38 家 |
| 成功率 | 100% |

### 解析測試

| 項目 | 結果 |
|------|------|
| 一般 PDF 解析 | 36 家 (100%) |
| OCR 解析 | 2 家 (部分成功) |
| 完整解析 (8/8) | 35 家 |
| 部分解析 | 3 家 |

---

## 使用說明

### 快速開始

```bash
# 安裝相依套件
pip install playwright pandas pdfplumber openpyxl
python -m playwright install chromium

# OCR 支援（可選）
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow

# 執行互動式介面
cd refactor && python cli.py

# 或使用命令列
python main.py 114Q1
```

### API 使用

```python
from refactor.core import ReportManager, DownloadManager

# 下載
dm = DownloadManager(data_dir='data')
result = dm.download('玉山商業銀行', 114, 1)

# 解析
rm = ReportManager()
df = rm.generate_report('data/114Q1', 'output/report.xlsx')

# OCR 解析（掃描式 PDF）
from refactor.core import OCRParser, is_scanned_pdf

if is_scanned_pdf('path/to/pdf'):
    parser = OCRParser()
    result = parser.parse_pdf('path/to/pdf', '銀行名稱')
```

---

## 更新日誌

| 日期 | 版本 | 變更內容 |
|------|------|----------|
| 2025-11-30 | 2.2 | 修復臺灣銀行下載器（URL、年份切換）、修復解析器（企業金融跨行格式） |
| 2024-11-29 | 2.1 | 新增 OCR 解析器、修復匯豐銀行下載器、新增下載器盤點文件 |
| 2024-11-29 | 2.0 | 重構架構：新增 core/, utils/ 模組 |
| 2024-11-29 | 1.1 | 修復企業金融類別解析問題 |
| 2024-11-25 | 1.0 | 初始 Playwright 版本、更新多家銀行下載器 |
