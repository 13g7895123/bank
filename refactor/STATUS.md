# 銀行財報系統 - 當前狀態報告

> 更新日期：2024-11-29

## 系統概覽

| 項目 | 數量/狀態 |
|------|-----------|
| 支援銀行數 | 38 家 |
| 下載器數量 | 38 個 |
| 業務類別 | 8 種 |
| 核心模組 | 已重構 ✅ |
| OCR 支援 | 已實作 ✅ |

## 功能狀態

### 1. 下載功能 (Downloader)

使用 Playwright 進行網頁自動化下載銀行財報 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | 下載功能正常 |
| ⚠️ 需更新 | 銀行網站已變更，需更新爬蟲邏輯 |
| ❌ 不可用 | 下載失敗 |

**下載方式統計**：
| 方式 | 數量 | 說明 |
|------|------|------|
| URL 直接下載 | 31 家 | `download_pdf_from_url` |
| 點擊下載 | 4 家 | `expect_download` |
| 特殊處理 | 3 家 | GraphQL API / JavaScript |

### 2. 解析功能 (Parser)

使用 pdfplumber 解析 PDF 並提取資產品質資料。

| 狀態 | 說明 |
|------|------|
| ✅ 完整 | 8/8 類別全部解析成功 |
| ⚠️ 部分 | 解析成功但缺少部分類別 |
| ❌ 失敗 | 無法解析 |

### 3. OCR 功能 (新增)

使用 Tesseract OCR 處理掃描式 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | OCR 解析器已實作 |
| ⚠️ 部分 | 受 PDF 品質影響，部分類別無法辨識 |

---

## 各銀行狀態明細

| 代碼 | 銀行名稱 | 下載功能 | 解析功能 | 備註 |
|------|----------|----------|----------|------|
| 01 | 臺灣銀行 | ✅ | ✅ | |
| 02 | 臺灣土地銀行 | ✅ | ✅ | 下載器已更新 |
| 03 | 合作金庫商業銀行 | ✅ | ✅ | |
| 04 | 第一商業銀行 | ✅ | ✅ | 點擊下載方式 |
| 05 | 華南商業銀行 | ✅ | ✅ | 下載器已更新 |
| 06 | 彰化商業銀行 | ✅ | ✅ | 已修復企業金融解析 |
| 07 | 上海商業儲蓄銀行 | ✅ | ✅ | |
| 08 | 台北富邦銀行 | ✅ | ✅ | 已修復企業金融解析，固定 URL |
| 09 | 國泰世華商業銀行 | ✅ | ✅ | |
| 10 | 中國輸出入銀行 | ✅ | ⚠️ | 政策性銀行，無消費金融業務 |
| 11 | 高雄銀行 | ✅ | ✅ | 下載器已更新 |
| 12 | 兆豐國際商業銀行 | ✅ | ✅ | 下載器已更新，iframe 處理 |
| 13 | 花旗（台灣）銀行 | ✅ | ✅ | |
| 15 | 王道商業銀行 | ✅ | ✅ | 已修復企業金融解析 |
| 16 | 臺灣中小企業銀行 | ✅ | ✅ | 下載器已更新 |
| 17 | 渣打國際商業銀行 | ✅ | ✅ | 固定 URL 格式 |
| 18 | 台中商業銀行 | ✅ | ✅ | 下載器已更新，JavaScript fetch |
| 19 | 京城商業銀行 | ✅ | ✅ | |
| 20 | 匯豐(台灣)商業銀行 | ✅ | ⚠️ | 下載器已修復，OCR 可解析 4/8 類別 |
| 21 | 瑞興商業銀行 | ✅ | ⚠️ | OCR 可解析 3/8 類別 |
| 22 | 華泰商業銀行 | ✅ | ✅ | |
| 23 | 臺灣新光商業銀行 | ✅ | ✅ | 下載器已更新 |
| 24 | 陽信商業銀行 | ✅ | ✅ | 下載器已更新，點擊下載 |
| 25 | 板信商業銀行 | ✅ | ✅ | |
| 26 | 三信商業銀行 | ✅ | ✅ | |
| 27 | 聯邦商業銀行 | ✅ | ✅ | 下載器已更新，已修復企業金融解析 |
| 28 | 遠東國際商業銀行 | ✅ | ✅ | |
| 29 | 元大商業銀行 | ✅ | ✅ | |
| 30 | 永豐商業銀行 | ✅ | ✅ | 下載器已更新，新視窗處理 |
| 31 | 玉山商業銀行 | ✅ | ✅ | 已修復企業金融解析，證交所查詢 |
| 32 | 凱基商業銀行 | ✅ | ✅ | 下載器已更新 |
| 33 | 星展(台灣)商業銀行 | ✅ | ✅ | 下載器已更新，固定 URL |
| 34 | 台新國際商業銀行 | ✅ | ✅ | 已修復企業金融解析 |
| 36 | 安泰商業銀行 | ✅ | ✅ | |
| 37 | 中國信託商業銀行 | ✅ | ✅ | 固定 URL 格式 |
| 38 | 樂天國際商業銀行 | ✅ | ✅ | 下載器已更新，GraphQL API |
| 40 | 連線商業銀行 | ✅ | ✅ | LINE Bank |
| 41 | 將來商業銀行 | ✅ | ✅ | Next Bank |

> **註**：代碼 14、35、39 無對應銀行

---

## 已知問題與修復記錄

### 已修復問題

#### 1. 企業金融類別解析失敗 (2024-11-29 修復)

**問題描述**：
- 6 家銀行的「企業金融_擔保」、「企業金融_無擔保」無法解析
- 原因：PDF 表格中文字格式為 `企 業\n金 融`（有空格和換行）

**影響銀行**：
- 彰化商業銀行、台北富邦銀行、王道商業銀行
- 聯邦商業銀行、玉山商業銀行、台新國際商業銀行

**解決方案**：
- 新增 `normalize_text()` 函數，移除空格和換行後再比對關鍵字
- 修改位置：`report_generator.py` 及 `utils/text.py`

#### 2. 匯豐(台灣)商業銀行下載失敗 (2024-11-29 修復)

**問題描述**：
- 原下載器無法正確找到 114Q1 財報連結
- 搜尋邏輯使用錯誤的 CSS 選擇器

**解決方案**：
- 修改搜尋邏輯，改為搜尋「{西元年}年{季度}重要財務業務資訊」
- 修改位置：`banks/bank_20_hsbc.py`

#### 3. 多家銀行下載器更新 (2024-11-25 ~ 2024-11-29)

已更新下載器的銀行：
- 02 臺灣土地銀行
- 04 第一商業銀行
- 05 華南商業銀行
- 11 高雄銀行
- 12 兆豐國際商業銀行
- 16 臺灣中小企業銀行
- 18 台中商業銀行
- 23 臺灣新光商業銀行
- 24 陽信商業銀行
- 27 聯邦商業銀行
- 30 永豐商業銀行
- 32 凱基商業銀行
- 33 星展(台灣)商業銀行
- 38 樂天國際商業銀行

### 待處理問題

#### 1. OCR 解析準確率

以下銀行的 PDF 為掃描圖片格式，OCR 解析受 PDF 品質影響：

| 銀行 | OCR 結果 | 備註 |
|------|----------|------|
| 匯豐(台灣)商業銀行 | 4/8 類別 | 表格結構較複雜 |
| 瑞興商業銀行 | 3/8 類別 | 掃描品質較低 |

**OCR 解析器位置**：`core/ocr_parser.py`

**安裝需求**：
```bash
# macOS
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow
```

#### 2. 政策性銀行

- 中國輸出入銀行 (10)：無消費金融業務，僅有企業金融資料

---

## 模組結構

```
refactor/
├── core/                    # 核心模組
│   ├── __init__.py
│   ├── models.py            # 資料模型
│   ├── download_manager.py  # 下載管理器
│   ├── report_manager.py    # 報表管理器
│   └── ocr_parser.py        # OCR 解析器（新增）
│
├── banks/                   # 銀行下載器（38 個）
│   ├── base.py              # 基礎類別
│   └── bank_XX_xxx.py       # 各銀行實作
│
├── utils/                   # 工具模組
│   ├── __init__.py
│   ├── text.py              # 文字處理
│   ├── date.py              # 日期處理
│   └── file.py              # 檔案處理
│
├── docs/                    # 文件
│   ├── DOWNLOADER_AUDIT.md  # 下載器盤點報告
│   └── *.md                 # 調查報告
│
├── tests/                   # 測試工具
│   ├── diagnose_failed_banks.py
│   └── test_all.py
│
├── downloader.py            # 下載器主模組
├── report_generator.py      # 報表生成器
├── cli.py                   # 互動式介面
├── main.py                  # 命令列主程式
├── ARCHITECTURE.md          # 架構說明
└── STATUS.md                # 狀態說明（本文件）
```

---

## 測試結果 (114Q1)

### 下載測試

| 項目 | 結果 |
|------|------|
| 測試銀行數 | 38 家 |
| 成功下載 | 38 家 |
| 成功率 | 100% |

### 解析測試

| 項目 | 結果 |
|------|------|
| 一般 PDF 解析 | 36 家 (100%) |
| OCR 解析 | 2 家 (部分成功) |
| 完整解析 (8/8) | 35 家 |
| 部分解析 | 3 家 |

---

## 使用說明

### 快速開始

```bash
# 安裝相依套件
pip install playwright pandas pdfplumber openpyxl
python -m playwright install chromium

# OCR 支援（可選）
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow

# 執行互動式介面
cd refactor && python cli.py

# 或使用命令列
python main.py 114Q1
```

### API 使用

```python
from refactor.core import ReportManager, DownloadManager

# 下載
dm = DownloadManager(data_dir='data')
result = dm.download('玉山商業銀行', 114, 1)

# 解析
rm = ReportManager()
df = rm.generate_report('data/114Q1', 'output/report.xlsx')

# OCR 解析（掃描式 PDF）
from refactor.core import OCRParser, is_scanned_pdf

if is_scanned_pdf('path/to/pdf'):
    parser = OCRParser()
    result = parser.parse_pdf('path/to/pdf', '銀行名稱')
```

---

## 更新日誌

| 日期 | 版本 | 變更內容 |
|------|------|----------|
| 2024-11-29 | 2.1 | 新增 OCR 解析器、修復匯豐銀行下載器、新增下載器盤點文件 |
| 2024-11-29 | 2.0 | 重構架構：新增 core/, utils/ 模組 |
| 2024-11-29 | 1.1 | 修復企業金融類別解析問題 |
| 2024-11-25 | 1.0 | 初始 Playwright 版本、更新多家銀行下載器 |
