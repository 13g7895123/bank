# 銀行財報系統 - 當前狀態報告

> 更新日期：2025-11-30 13:31（重構為非同步多工架構）

## 系統概覽

| 項目 | 數量/狀態 |
|------|-----------|
| 支援銀行數 | 38 家 |
| 下載器數量 | 38 個 |
| 架構 | **非同步 (async/await)** |
| 並行支援 | ✅ 支援並行下載 |
| 業務類別 | 8 種 |
| 核心模組 | 已重構 ✅ |
| OCR 支援 | 已實作 ✅ |
| 無頭模式自動切換 | 已實作 ✅ |

## 功能狀態

### 1. 下載功能 (Downloader)

使用 Playwright 進行網頁自動化下載銀行財報 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | 下載功能正常 |
| ⚠️ 無資料 | 該季度尚無資料或網站僅保留近期資料 |
| ❌ 錯誤 | 下載失敗（Timeout/環境問題） |

**下載方式統計**：
| 方式 | 數量 | 說明 |
|------|------|------|
| URL 直接下載 | 31 家 | `download_pdf_from_url` |
| 點擊下載 | 4 家 | `expect_download` |
| 特殊處理 | 3 家 | GraphQL API / JavaScript |

**無頭/有頭模式**：
- 預設使用無頭模式
- 下載後自動驗證 PDF 檔案
- 驗證失敗時自動切換有頭模式重試

### 2. 解析功能 (Parser)

使用 pdfplumber 解析 PDF 並提取資產品質資料。

| 狀態 | 說明 |
|------|------|
| ✅ 完整 | 8/8 類別全部解析成功 |
| ⚠️ 部分 | 解析成功但缺少部分類別 |
| ❌ 失敗 | 無法解析（PDF 格式特殊） |

### 3. OCR 功能

使用 Tesseract OCR 處理掃描式 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | OCR 解析器已實作 |
| ⚠️ 部分 | 受 PDF 品質影響，部分類別無法辨識 |

---

## 各銀行狀態明細

> 更新日期：2025-11-30 20:10（新增遠東銀行專用解析器）

| 代碼 | 銀行名稱 | 113Q4 下載 | 113Q4 解析 | 113Q4 頁碼 | 114Q1 下載 | 114Q1 解析 | 114Q1 頁碼 | 備註 |
|------|----------|------------|------------|------------|------------|------------|------------|------|
| 01 | 臺灣銀行 | ✅ | ✅ 8/8 | p.112 | ✅ | ✅ 8/8 | p.4 | 已輸出 xlsx |
| 02 | 臺灣土地銀行 | ✅ | ✅ 8/8 | p.81 | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx |
| 03 | 合作金庫商業銀行 | ✅ | ✅ 8/8 | p.1 | ✅ | ✅ 8/8 | p.1 | 已輸出 xlsx |
| 04 | 第一商業銀行 | ✅ | ✅ 8/8 | p.1 | ✅ | ✅ 8/8 | p.1 | 已輸出 xlsx，強制有頭模式 |
| 05 | 華南商業銀行 | ✅ | ✅ 8/8 | p.107 | ✅ | ✅ 8/8 | p.87 | 已輸出 xlsx，新增年份切換功能 |
| 06 | 彰化商業銀行 | ✅ | ✅ 8/8 | p.3 | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx，Q4對應年度資料 |
| 07 | 上海商業儲蓄銀行 | ✅ | ✅ 8/8 | p.3 | ✅ | ❌ 0/8 | p.103 | 已輸出 xlsx (僅113Q4)，114Q1 表格為垂直文字格式需專用解析器 |
| 08 | 台北富邦銀行 | ✅ | ✅ 8/8 | p.10 | ✅ | ✅ 8/8 | p.7 | 已輸出 xlsx |
| 09 | 國泰世華商業銀行 | ✅ | ⚠️ 7/8 | p.6 | ✅ | ⚠️ 7/8 | p.5 | 已輸出 xlsx，無現金卡業務故缺 1 類別（正常）|
| 10 | 中國輸出入銀行 | ✅ | ⚠️ 3/8 | p.1 | ✅ | ⚠️ 3/8 | p.1 | 已輸出 xlsx (政策性銀行，僅3類別) |
| 11 | 高雄銀行 | ✅ | ✅ 8/8 | p.77 | ✅ | ✅ 8/8 | p.72 | 已輸出 xlsx |
| 12 | 兆豐國際商業銀行 | ✅ | ✅ 8/8 | p.1 | ✅ | ✅ 8/8 | p.1 | 已輸出 xlsx，修正下載連結選擇器 |
| 13 | 花旗（台灣）銀行 | ✅ | ✅ 8/8 | p.3 | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx，更新網址+有頭模式 |
| 15 | 王道商業銀行 | ✅ | ✅ 8/8 | p.5 | ✅ | ✅ 8/8 | p.6 | 已輸出 xlsx，修正列表搜尋邏輯 |
| 16 | 臺灣中小企業銀行 | ✅ | ✅ 8/8 | p.110 | ✅ | ✅ 8/8 | p.98 | 已輸出 xlsx |
| 17 | 渣打國際商業銀行 | ✅ | ⚠️ 7/8 | p.85 | ✅ | ⚠️ 7/8 | p.4 | 已輸出 xlsx，無現金卡業務故缺 1 類別（正常）|
| 18 | 台中商業銀行 | ✅ | ✅ 8/8 | p.41 | ✅ | ✅ 8/8 | p.109 | 已輸出 xlsx |
| 19 | 京城商業銀行 | ✅ | ✅ 8/8 | p.109 | ✅ | ✅ 8/8 | p.105 | 已輸出 xlsx，修正多年度表格搜尋 |
| 20 | 匯豐(台灣)商業銀行 | ✅ | ✅ 8/8 | p.4 | ✅ | ⚠️ OCR | p.4 | 已輸出 xlsx，114Q1 需 OCR（已測試可辨識）|
| 21 | 瑞興商業銀行 | ✅ | ⚠️ OCR | p.4 | ✅ | ⚠️ OCR | p.4 | 掃描式 PDF，需 OCR（已測試可辨識部分資料）|
| 22 | 華泰商業銀行 | ✅ | ⚠️ 5/8 | p.3 | ✅ | ⚠️ 5/8 | p.3 | 已輸出 xlsx，表格多類別合併格式+無現金卡業務 |
| 23 | 臺灣新光商業銀行 | ✅ | ❌ 0/8 | - | ✅ | ✅ 8/8 | p.1 | 已輸出 xlsx (僅114Q1)，113Q4 PDF 僅含聲明頁無資料 |
| 24 | 陽信商業銀行 | ✅ | ✅ 8/8 | p.16 | ✅ | ✅ 8/8 | p.4 | 已輸出 xlsx |
| 25 | 板信商業銀行 | ✅ | ❌ 0/8 | - | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx (僅114Q1)，113Q4 PDF 無資產品質表格 |
| 26 | 三信商業銀行 | ✅ | ✅ 8/8 | p.3 | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx，修正為 MNews 資料來源 |
| 27 | 聯邦商業銀行 | ✅ | ❌ 0/8 | - | ✅ | ✅ 8/8 | p.11 | 已輸出 xlsx (僅114Q1)，113Q4 PDF Pattern 錯誤無法解析 |
| 28 | 遠東國際商業銀行 | ✅ | ✅ 8/8 | p.3 | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx，新增字元位置重組解析器 |
| 29 | 元大商業銀行 | ✅ | ❌ 0/8 | - | ✅ | ✅ 8/8 | p.5 | 已輸出 xlsx (僅114Q1)，113Q4 PDF 無資產品質表格 |
| 30 | 永豐商業銀行 | ✅ | ✅ 8/8 | p.82 | ✅ | ✅ 8/8 | p.81 | 已輸出 xlsx |
| 31 | 玉山商業銀行 | ✅ | ✅ 8/8 | p.109 | ✅ | ✅ 8/8 | p.84 | 已輸出 xlsx |
| 32 | 凱基商業銀行 | ✅ | ✅ 8/8 | p.88 | ✅ | ✅ 8/8 | p.66 | 已輸出 xlsx |
| 33 | 星展(台灣)商業銀行 | ✅ | ❌ 0/8 | - | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx (僅114Q1)，113Q4 PDF 僅含索引頁，資產品質在財報附註 |
| 34 | 台新國際商業銀行 | ✅ | ✅ 8/8 | - | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx，新增年份下拉選單切換 |
| 36 | 安泰商業銀行 | ✅ | ✅ 8/8 | - | ✅ | ✅ 8/8 | p.80 | 已輸出 xlsx，修正表格結構解析 |
| 37 | 中國信託商業銀行 | ✅ | ⚠️ 5/8 | p.5 | ✅ | ❌ 0/8 | p.7 | 已輸出 xlsx (僅113Q4 5筆)，表格為垂直文字排版需專用解析器 |
| 38 | 樂天國際商業銀行 | ✅ | ✅ 8/8 | p.4 | ✅ | ✅ 8/8 | p.3 | 已輸出 xlsx |
| 40 | 連線商業銀行 | ✅ | ✅ 8/8 | p.9 | ⚠️ 無資料 | - | - | 已輸出 xlsx (僅113Q4)，網站無114Q1 |
| 41 | 將來商業銀行 | ✅ | ✅ 8/8 | p.1 | ✅ | ✅ 8/8 | p.1 | 已輸出 xlsx，強制有頭模式 |

> **註**：代碼 14、35、39 無對應銀行

---

## 測試統計 (2025-11-30)

### 113Q4 下載結果

| 狀態 | 數量 | 說明 |
|------|------|------|
| ✅ 成功 | 24 家 | 下載成功 |
| ⚠️ 無資料 | 10 家 | 網站無該季度資料 |
| ❌ 錯誤 | 4 家 | Timeout |

### 114Q1 下載結果

| 狀態 | 數量 | 說明 |
|------|------|------|
| ✅ 成功 | 30 家 | 下載成功 |
| ⚠️ 無資料 | 4 家 | 網站無該季度資料 |
| ❌ 錯誤 | 4 家 | Timeout |

### 解析結果統計

| 狀態 | 113Q4 | 114Q1 |
|------|-------|-------|
| ✅ 完整 (8/8) | 20 家 | 27 家 |
| ⚠️ 部分成功 | 3 家 | 2 家 |
| ❌ 失敗 (0/8) | 1 家 | 1 家 |

### 輸出檔案統計

- 總輸出檔案：32 個 xlsx
- 完整資料 (16筆)：13 家銀行
- 部分資料：19 家銀行

### 無法下載的銀行 (需修復)

| 銀行 | 113Q4 | 114Q1 | 問題 |
|------|-------|-------|------|
| 09 國泰世華 | ❌ | ❌ | Timeout (無頭模式) |
| 13 花旗(台灣) | ❌ | ❌ | Timeout (無頭模式) |
| 41 將來銀行 | ❌ | ❌ | Timeout (無頭模式) |

### 下載成功但解析失敗 (需修復解析器)

| 銀行 | 113Q4 | 114Q1 | 問題 |
|------|-------|-------|------|
| 07 上海商銀 | ✅ 8/8 | ❌ 0/8 | 114Q1 表格為垂直文字格式，數據存在但需專用解析器 |
| 20 匯豐銀行 | ✅ 8/8 | ⚠️ OCR | 114Q1 為掃描式 PDF，已測試 OCR 可辨識 |
| 21 瑞興銀行 | ⚠️ OCR | ⚠️ OCR | 掃描式 PDF，已測試 OCR 可部分辨識 |
| 23 新光銀行 | ❌ 0/8 | ✅ 8/8 | 113Q4 PDF 僅含聲明頁（無法修復）|
| 25 板信銀行 | ❌ 0/8 | ✅ 8/8 | 113Q4 PDF 無資產品質表格（無法修復）|
| 26 三信銀行 | ❌ 0/8 | ✅ 8/8 | 113Q4 為資本適足性報告（無法修復）|
| 27 聯邦銀行 | ❌ 0/8 | ✅ 8/8 | 113Q4 PDF Pattern 錯誤（無法修復）|
| 28 遠東銀行 | ❌ 0/8 | ❌ 0/8 | PDF 文字被拆散成單字排列，數據存在但需專用解析器 |
| 29 元大銀行 | ❌ 0/8 | ✅ 8/8 | 113Q4 PDF 無資產品質表格（無法修復）|
| 33 星展銀行 | ❌ 0/8 | ✅ 8/8 | 113Q4 PDF 僅含索引頁（無法修復）|
| 37 中國信託 | ⚠️ 5/8 | ❌ 0/8 | 表格為垂直文字排版，需專用解析器 |

**問題分類**：
- ❌ 無法修復（PDF 本身無資料）：23, 25, 27, 29, 33 的 113Q4
- ⚠️ 需 OCR：20 的 114Q1, 21 的 113Q4/114Q1
- ⚠️ 需專用解析器：07 的 114Q1, 37 的 113Q4/114Q1

---

## 已知問題與修復記錄

#### 14. 遠東銀行專用解析器 (2025-11-30 20:10)

**問題**：PDF 文字被拆散成單字排列，pdfplumber 的 `extract_text()` 和 `extract_tables()` 無法正確提取。

**根因分析**：
1. 遠東銀行的 PDF 使用特殊的文字編碼/排版方式
2. 文字被拆散成單字垂直排列，標準解析方法無法識別表格結構
3. 但字元的 X/Y 座標位置資訊仍然正確

**解決方案**：
- 在 `report_generator.py` 新增 `extract_feib_by_position()` 函數
- 使用 pdfplumber 的 `page.chars` 取得所有字元及其座標
- 按 Y 座標分組成行，按 X 座標排序重組文字
- 使用固定的 X 座標邊界（210, 276, 358, 395）分割欄位
- 欄位順序：業務別 | 逾期放款 | 放款總額 | 比率

**測試結果**：
| 季度 | 解析結果 | 驗證 |
|------|----------|------|
| 113Q4 | ✅ 8/8 | 數據正確 |
| 114Q1 | ✅ 8/8 | 數據正確 |

#### 13. 三信銀行資料來源修正 (2025-11-30 19:55)

**問題**：113Q4 下載的 PDF 是「資本適足性報告」而非「資產品質」報表，導致解析失敗 0/8。

**根因分析**：
1. 原程式使用 `riskman` 路徑（財務業務資訊），只有半年度資料（6月/12月）
2. `riskman` PDF 是「資本適足性與風險管理」報告，不含資產品質表格
3. 正確的資料來源是 `MNews`（重要財務業務資訊），有每季資料並包含資產品質

**解決方案**：
- 修改 `bank_26_cotabank.py`，改用 MNews 資料來源
- URL 格式：`MNews{年}{月}.pdf`，例如 `MNews11312.pdf` = 113年12月 = Q4

**測試結果**：
| 季度 | 下載 | 解析 | 驗證 |
|------|------|------|------|
| 113Q4 | ✅ | ✅ 8/8 | 內容正確為「資產品質」|
| 114Q1 | ✅ | ✅ 8/8 | 內容正確為「資產品質」|

#### 12. 兆豐銀行下載連結修正 (2025-11-30 19:40)

**問題**：下載的 PDF 內容為「無障礙服務設施表」而非「資產品質」報表。

**根因分析**：
1. 兆豐銀行網頁上「資產品質」連結設定 `target="_blank"` 會另開新視窗
2. 原程式點擊連結後，Playwright 仍停留在原頁面
3. 再用 `a[href*=".pdf"]` 找 PDF 時，會找到頁面第一個 PDF 連結（無障礙設施）

**解決方案**：
- 修改 `bank_12_megabank.py`，直接從資產品質連結取得 `href` 屬性
- 不需要點擊連結，避免另開新視窗的問題

**測試結果**：
| 季度 | 下載 | 解析 | 驗證 |
|------|------|------|------|
| 113Q4 | ✅ | ✅ 8/8 | 內容正確為「資產品質」|
| 114Q1 | ✅ | ✅ 8/8 | 內容正確為「資產品質」|

#### 11. OCR 解析測試 (2025-11-30 測試)

針對掃描式 PDF 進行 OCR 解析測試：

**環境配置**：
- tesserocr 2.9.1（內建 tesseract 5.5.1）
- PyMuPDF 1.26.6（PDF 轉圖片）
- 繁體中文+英文語言包（chi_tra+eng）

**測試結果**：

| 銀行 | 季度 | OCR 頁碼 | 結果 | 說明 |
|------|------|----------|------|------|
| 20 匯豐銀行 | 114Q1 | p.4 | ✅ 可辨識 | 8/8 類別可提取，需手動清理數字格式 |
| 21 瑞興銀行 | 113Q4 | p.4 | ⚠️ 部分 | 部分資料可辨識，OCR 品質受原始掃描影響 |

**20 匯豐銀行 114Q1 OCR 提取資料**：
| 類別 | 逾期放款 | 放款總額 | 逾放比率 |
|------|----------|----------|----------|
| 企業金融_擔保 | 0 | 6,363,256 | 0% |
| 企業金融_無擔保 | 0 | 99,847,100 | 0% |
| 住宅抵押貸款 | 40,799 | 153,564,122 | 0.03% |
| 現金卡 | 22 | 10,363 | 0.21% |
| 小額純信用貸款 | 159,062 | 20,902,317 | 0.76% |
| 其他_擔保 | 770 | 49,696,307 | 0% |
| 其他_無擔保 | 0 | 7,618,210 | 0% |
| 合計 | 200,649 | 338,001,675 | 0.06% |

**待辦事項**：
- 整合 OCR 解析器到主程式流程
- 改進數字格式清理邏輯
- 加入自動判斷是否需要 OCR 的功能

#### 10. 解析錯誤分析報告 (2025-11-30 分析)

針對 113Q4 與 114Q1 解析為 ❌ 0/8 的項目進行詳細分析：

**113Q4 解析錯誤（6 項）**：

| 代碼 | 銀行名稱 | 問題分類 | 說明 |
|------|----------|----------|------|
| 21 | 瑞興商業銀行 | 掃描式 PDF | 全部頁面為掃描影像，無文字層，需 OCR |
| 23 | 臺灣新光商業銀行 | PDF 內容問題 | 僅 1 頁聲明，無實際資產品質資料 |
| 25 | 板信商業銀行 | PDF 內容問題 | 無資產品質表格（僅存款/放款比率資訊）|
| 27 | 聯邦商業銀行 | PDF Pattern 錯誤 | pdfplumber 無法正確讀取，Pattern 錯誤 |
| 29 | 元大商業銀行 | PDF 內容問題 | 無資產品質表格（僅存款/放款資訊）|
| 33 | 星展(台灣)商業銀行 | PDF 內容問題 | 僅索引頁，資產品質在財報附註中 |

**114Q1 解析錯誤（4 項）**：

| 代碼 | 銀行名稱 | 問題分類 | 說明 |
|------|----------|----------|------|
| 07 | 上海商業儲蓄銀行 | 特殊格式 | 特殊排版格式 |
| 20 | 匯豐(台灣)商業銀行 | 掃描式 PDF | 大部分頁面為掃描影像，需 OCR |
| 21 | 瑞興商業銀行 | 掃描式 PDF | 同 113Q4 |
| 37 | 中國信託商業銀行 | 特殊格式 | 垂直文字表格排版 |

**問題分類統計**：
- PDF 內容問題（4 項）：PDF 不含資產品質資料，無法透過程式修復
- 掃描式 PDF（3 項）：需安裝 Tesseract OCR 才能處理
- 特殊格式（3 項）：需開發專用解析器處理特殊排版

**結論**：
- 約 36% 的錯誤是因為 PDF 本身不包含所需資料，需向銀行確認是否有其他來源
- 約 27% 需要 OCR 功能（需安裝 tesseract + pytesseract + pdf2image）
- 約 36% 需要開發專用解析器

#### 9. 台新國際商業銀行與安泰商業銀行下載器修復 (2025-11-30 修復)

**台新國際商業銀行 (34)**：
- **問題描述**：網頁上方有年份下拉選單，原程式碼未處理年份切換，導致只能下載當年資料
- **解決方案**：使用 JavaScript 觸發年份下拉選單的 change 事件來切換年份
- **網址**：`https://www.taishinbank.com.tw/TSB/about-taishin/brief-introduction-to-the-bank/financeInfo`

**安泰商業銀行 (36)**：
- **問題描述**：原程式碼搜尋邏輯錯誤，無法正確匹配年度與季度
- **解決方案**：重寫下載邏輯，改用表格結構解析（年度行如 "114年度" + 季度連結行）
- **網址**：`https://www.entiebank.com.tw/entie/disclosure-financial`

**測試結果**：
- 台新 113Q3 下載成功 ✅（可取得 PDF URL）
- 安泰 113Q3 下載成功 ✅（可取得 PDF URL）

#### 8. 臺灣土地銀行下載器修復 + refactor 路徑修正 (2025-11-30 修復)

**問題描述**：
1. **下載器問題**：原下載器使用 `th` 選擇器尋找年度列，但實際網頁結構使用 `td`
2. **路徑問題**：`cli.py`、`main.py`、`report_generator.py` 使用 `parent.parent` 指向 bank 目錄，應為 refactor 目錄

**表格結構說明**：
- 每兩行為一組：第一行是年度標題+季度標題，第二行是對應的下載連結
- row[0]: td[0]=114年度, td[1]=第一季標題, td[2]=第二季標題...
- row[1]: td[0]=財務報告連結, td[1]=財務報告連結...

**解決方案**：
1. 修正下載器邏輯：
   - 改用 `td` 定位年度列
   - 取得下一行（連結行）的對應季度連結
   - 修改檔案：`banks/bank_02_landbank.py`

2. 修正路徑設定：
   - `cli.py`：`get_base_dir()` 改為 `Path(__file__).parent`
   - `main.py`：`run_report()` 改為 `Path(__file__).parent`
   - `report_generator.py`：`__main__` 區塊改為 `Path(__file__).parent`

**測試結果**：
- 114Q1 下載成功 ✅（1.6 MB）
- PDF 解析成功 8/8 類別 ✅
- 路徑正確指向 refactor/data ✅

#### 7. 臺灣土地銀行下載與解析驗證 (2025-11-30 驗證)

**測試結果**：
- 114Q1 下載成功 ✅（2.2 MB，檔案已存在）
- PDF 解析成功 8/8 類別 ✅

**解析資料摘要**（114Q1）：
| 業務別項目 | 逾期放款(仟元) | 放款總額(仟元) | 逾放比率 |
|------------|---------------|---------------|---------|
| 企業金融_擔保 | 990,933 | 673,930,753 | 0.15% |
| 企業金融_無擔保 | 228,122 | 496,848,569 | 0.05% |
| 消費金融_住宅抵押貸款 | 1,074,313 | 1,163,073,214 | 0.09% |
| 消費金融_現金卡 | 0 | 1,386 | 0.00% |
| 消費金融_小額純信用貸款 | 5,588 | 3,984,597 | 0.14% |
| 消費金融_其他_擔保 | 359,562 | 100,295,538 | 0.36% |
| 消費金融_其他_無擔保 | 13,925 | 26,651,341 | 0.05% |
| 合計 | 2,672,443 | 2,464,785,398 | 0.11% |

#### 5. 臺灣銀行下載器修復 (2025-11-30 修復)

**問題描述**：
- URL 路徑缺少 `/tw`，導致無法正確載入財報頁面
- 匹配字串格式錯誤：多餘空格、使用中文數字而非阿拉伯數字
- 未支援年份切換下拉選單，無法下載 114 年資料

**解決方案**：
- 修正 URL：`/about/...` → `/tw/about/...`
- 修正匹配字串：`個體財務報告 {year}年{quarter_text}` → `個體財務報告{year}年第{quarter}季`
- 修正下載 URL：移除多餘的 `{domain}/` 前綴（link 已是完整 URL）
- 新增年份切換功能：點擊下拉選單切換到指定年份
- 修改位置：`get_Data.py` 第 40-85 行

**測試結果**：
- 113Q4 下載成功 ✅（2.98 MB）
- 114Q1 下載成功 ✅（331 KB）
- PDF 解析成功 8/8 類別 ✅
- 已改用 Playwright 無頭模式（取代 Selenium）✅

#### 6. 臺灣銀行 PDF 解析修復 (2025-11-30 修復)

**問題描述**：
- 114Q1 PDF 表格格式特殊：「企業金融」的「擔保」和「無擔保」在同一欄位，但數據在不同行
- 原解析器無法正確識別「企業金融_無擔保」

**解決方案**：
- 新增 `pending_unsecured` 標記，處理跨行數據
- 當偵測到「企業金融」且 col1 包含「擔保\n無擔保」時，本行為擔保，下一行為無擔保
- 修改位置：`refactor/report_generator.py` 第 165-230 行

### 已修復問題

#### 1. 企業金融類別解析失敗 (2024-11-29 修復)

**問題描述**：
- 6 家銀行的「企業金融_擔保」、「企業金融_無擔保」無法解析
- 原因：PDF 表格中文字格式為 `企 業\n金 融`（有空格和換行）

**影響銀行**：
- 彰化商業銀行、台北富邦銀行、王道商業銀行
- 聯邦商業銀行、玉山商業銀行、台新國際商業銀行

**解決方案**：
- 新增 `normalize_text()` 函數，移除空格和換行後再比對關鍵字
- 修改位置：`report_generator.py` 及 `utils/text.py`

#### 2. 匯豐(台灣)商業銀行下載失敗 (2024-11-29 修復)

**問題描述**：
- 原下載器無法正確找到 114Q1 財報連結
- 搜尋邏輯使用錯誤的 CSS 選擇器

**解決方案**：
- 修改搜尋邏輯，改為搜尋「{西元年}年{季度}重要財務業務資訊」
- 修改位置：`banks/bank_20_hsbc.py`

#### 3. 多家銀行下載器更新 (2024-11-25 ~ 2024-11-29)

已更新下載器的銀行：
- 02 臺灣土地銀行
- 04 第一商業銀行
- 05 華南商業銀行
- 11 高雄銀行
- 12 兆豐國際商業銀行
- 16 臺灣中小企業銀行
- 18 台中商業銀行
- 23 臺灣新光商業銀行
- 24 陽信商業銀行
- 27 聯邦商業銀行
- 30 永豐商業銀行
- 32 凱基商業銀行
- 33 星展(台灣)商業銀行
- 38 樂天國際商業銀行

### 待處理問題

#### 1. 下載錯誤（需修復下載器）- 10 家

| 代碼 | 銀行 | 錯誤類型 | 說明 |
|------|------|----------|------|
| 09 | 國泰世華商業銀行 | Timeout | 網頁載入逾時 |
| 13 | 花旗（台灣）銀行 | Timeout | 網頁載入逾時 |
| 15 | 王道商業銀行 | Timeout | 網頁載入逾時 |
| 16 | 臺灣中小企業銀行 | 環境問題 | 需要 wget 工具 |
| 18 | 台中商業銀行 | Timeout | 網頁載入逾時 |
| 19 | 京城商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 22 | 華泰商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 25 | 板信商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 38 | 樂天國際商業銀行 | 環境問題 | Chromium 路徑問題 |
| 41 | 將來商業銀行 | Timeout | 網頁載入逾時 |

**建議**：
- Timeout 問題：增加 timeout 時間（目前 60 秒），或檢查網站結構是否變更
- 網路錯誤：可能是暫時性網路問題，建議稍後重試
- 環境問題：移除 wget 依賴，統一使用 Playwright；重新安裝 chromium

#### 2. PDF 解析失敗 - 5 家

| 代碼 | 銀行 | 問題 | 建議 |
|------|------|------|------|
| 12 | 兆豐國際商業銀行 | 找不到資產品質頁面 | 分析 PDF 結構 |
| 21 | 瑞興商業銀行 | 掃描式 PDF | 使用 OCR 解析 |
| 23 | 臺灣新光商業銀行 | 找不到資產品質頁面 | 分析 PDF 結構 |
| 27 | 聯邦商業銀行 | PDF Pattern 錯誤 | 處理特殊編碼 |
| 33 | 星展(台灣)商業銀行 | 特殊格式 | 分析 PDF 結構 |

#### 3. 部分解析成功 - 3 家

| 代碼 | 銀行 | 解析結果 | 說明 |
|------|------|----------|------|
| 10 | 中國輸出入銀行 | 3/8 | 政策性銀行，無消費金融 |
| 17 | 渣打國際商業銀行 | 7/8 | 缺少 1 類別 |
| 37 | 中國信託商業銀行 | 5/8 | 缺少 3 類別 |

#### 4. 無資料（非錯誤）- 7 家

這些銀行的 113Q4 資料尚未發布，或網站僅保留近期資料：
- 01 臺灣銀行、05 華南商業銀行、06 彰化商業銀行
- 07 上海商業儲蓄銀行、26 三信商業銀行、28 遠東國際商業銀行
- 29 元大商業銀行

**OCR 解析器位置**：`core/ocr_parser.py`

**安裝需求**：
```bash
# macOS
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow
```

---

## 模組結構

```
refactor/
├── core/                    # 核心模組
│   ├── __init__.py
│   ├── models.py            # 資料模型
│   ├── download_manager.py  # 下載管理器
│   ├── report_manager.py    # 報表管理器
│   └── ocr_parser.py        # OCR 解析器（新增）
│
├── banks/                   # 銀行下載器（38 個）
│   ├── base.py              # 基礎類別
│   └── bank_XX_xxx.py       # 各銀行實作
│
├── utils/                   # 工具模組
│   ├── __init__.py
│   ├── text.py              # 文字處理
│   ├── date.py              # 日期處理
│   └── file.py              # 檔案處理
│
├── docs/                    # 文件
│   ├── DOWNLOADER_AUDIT.md  # 下載器盤點報告
│   └── *.md                 # 調查報告
│
├── tests/                   # 測試工具
│   ├── diagnose_failed_banks.py
│   └── test_all.py
│
├── downloader.py            # 下載器主模組
├── report_generator.py      # 報表生成器
├── cli.py                   # 互動式介面
├── main.py                  # 命令列主程式
├── ARCHITECTURE.md          # 架構說明
└── STATUS.md                # 狀態說明（本文件）
```

---

## 測試結果 (114Q1)

### 下載測試

| 項目 | 結果 |
|------|------|
| 測試銀行數 | 38 家 |
| 成功下載 | 38 家 |
| 成功率 | 100% |

### 解析測試

| 項目 | 結果 |
|------|------|
| 一般 PDF 解析 | 36 家 (100%) |
| OCR 解析 | 2 家 (部分成功) |
| 完整解析 (8/8) | 35 家 |
| 部分解析 | 3 家 |

---

## 使用說明

### 快速開始

```bash
# 安裝相依套件
pip install playwright pandas pdfplumber openpyxl
python -m playwright install chromium

# OCR 支援（可選）
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow

# 執行互動式介面
cd refactor && python cli.py

# 或使用命令列
python main.py 114Q1
```

### API 使用

```python
from refactor.core import ReportManager, DownloadManager

# 下載
dm = DownloadManager(data_dir='data')
result = dm.download('玉山商業銀行', 114, 1)

# 解析
rm = ReportManager()
df = rm.generate_report('data/114Q1', 'output/report.xlsx')

# OCR 解析（掃描式 PDF）
from refactor.core import OCRParser, is_scanned_pdf

if is_scanned_pdf('path/to/pdf'):
    parser = OCRParser()
    result = parser.parse_pdf('path/to/pdf', '銀行名稱')
```

---

## 更新日誌

| 日期 | 版本 | 變更內容 |
|------|------|----------|
| 2025-11-30 | 3.2 | **OCR 解析測試**：使用 tesserocr + PyMuPDF 測試掃描式 PDF OCR，成功解析匯豐 114Q1、瑞興 113Q4 部分資料，更新各銀行 PDF 頁碼 |
| 2025-11-30 | 3.1 | **解析錯誤分析**：詳細分析 113Q4/114Q1 共 15 項解析錯誤原因（PDF 內容問題 6 項、掃描式 PDF 3 項、特殊格式 4 項），更新狀態備註 |
| 2025-11-30 | 3.0 | **重構為非同步架構**：所有下載器改用 async/await，支援並行下載多家銀行 |
| 2025-11-30 | 2.3 | 修復台新銀行下載器（新增年份下拉選單切換）、修復安泰銀行下載器（表格結構解析） |
| 2025-11-30 | 2.2 | 修復臺灣銀行下載器（URL、年份切換）、修復解析器（企業金融跨行格式） |
| 2024-11-29 | 2.1 | 新增 OCR 解析器、修復匯豐銀行下載器、新增下載器盤點文件 |
| 2024-11-29 | 2.0 | 重構架構：新增 core/, utils/ 模組 |
| 2024-11-29 | 1.1 | 修復企業金融類別解析問題 |
| 2024-11-25 | 1.0 | 初始 Playwright 版本、更新多家銀行下載器 |
