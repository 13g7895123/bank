# 銀行財報系統 - 當前狀態報告

> 更新日期：2025-11-29 22:50（113Q4 完整測試）

## 系統概覽

| 項目 | 數量/狀態 |
|------|-----------|
| 支援銀行數 | 38 家 |
| 下載器數量 | 38 個 |
| 業務類別 | 8 種 |
| 核心模組 | 已重構 ✅ |
| OCR 支援 | 已實作 ✅ |
| 無頭模式自動切換 | 已實作 ✅ |

## 功能狀態

### 1. 下載功能 (Downloader)

使用 Playwright 進行網頁自動化下載銀行財報 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | 下載功能正常 |
| ⚠️ 無資料 | 該季度尚無資料或網站僅保留近期資料 |
| ❌ 錯誤 | 下載失敗（Timeout/環境問題） |

**下載方式統計**：
| 方式 | 數量 | 說明 |
|------|------|------|
| URL 直接下載 | 31 家 | `download_pdf_from_url` |
| 點擊下載 | 4 家 | `expect_download` |
| 特殊處理 | 3 家 | GraphQL API / JavaScript |

**無頭/有頭模式**：
- 預設使用無頭模式
- 下載後自動驗證 PDF 檔案
- 驗證失敗時自動切換有頭模式重試

### 2. 解析功能 (Parser)

使用 pdfplumber 解析 PDF 並提取資產品質資料。

| 狀態 | 說明 |
|------|------|
| ✅ 完整 | 8/8 類別全部解析成功 |
| ⚠️ 部分 | 解析成功但缺少部分類別 |
| ❌ 失敗 | 無法解析（PDF 格式特殊） |

### 3. OCR 功能

使用 Tesseract OCR 處理掃描式 PDF。

| 狀態 | 說明 |
|------|------|
| ✅ 可用 | OCR 解析器已實作 |
| ⚠️ 部分 | 受 PDF 品質影響，部分類別無法辨識 |

---

## 各銀行狀態明細（113Q4 測試結果）

| 代碼 | 銀行名稱 | 下載 | 解析 | 備註 |
|------|----------|------|------|------|
| 01 | 臺灣銀行 | ⚠️ 無資料 | - | 113Q4 尚無資料 |
| 02 | 臺灣土地銀行 | ⚠️ 無資料 | - | 113Q4 尚無資料 |
| 03 | 合作金庫商業銀行 | ✅ | ✅ 8/8 | |
| 04 | 第一商業銀行 | ✅ | ✅ 8/8 | 使用有頭模式 |
| 05 | 華南商業銀行 | ⚠️ 無資料 | - | 113Q4 尚無資料 |
| 06 | 彰化商業銀行 | ⚠️ 無資料 | - | 113Q4 尚無資料 |
| 07 | 上海商業儲蓄銀行 | ⚠️ 無資料 | - | 僅保留 114 年資料 |
| 08 | 台北富邦銀行 | ✅ | ✅ 8/8 | |
| 09 | 國泰世華商業銀行 | ❌ Timeout | - | 需修復下載器 |
| 10 | 中國輸出入銀行 | ✅ | ⚠️ 3/8 | 政策性銀行，無消費金融 |
| 11 | 高雄銀行 | ✅ | ✅ 8/8 | |
| 12 | 兆豐國際商業銀行 | ✅ | ❌ 0/8 | PDF 解析失敗 |
| 13 | 花旗（台灣）銀行 | ❌ Timeout | - | 需修復下載器 |
| 15 | 王道商業銀行 | ❌ Timeout | - | 需修復下載器 |
| 16 | 臺灣中小企業銀行 | ❌ 環境問題 | - | 需要 wget 工具 |
| 17 | 渣打國際商業銀行 | ✅ | ⚠️ 7/8 | 缺少 1 類別 |
| 18 | 台中商業銀行 | ❌ Timeout | - | 需修復下載器 |
| 19 | 京城商業銀行 | ❌ 網路錯誤 | - | 連線問題 |
| 20 | 匯豐(台灣)商業銀行 | ✅ | ✅ 8/8 | |
| 21 | 瑞興商業銀行 | ✅ | ❌ 0/8 | 掃描式 PDF，需 OCR |
| 22 | 華泰商業銀行 | ❌ 網路錯誤 | - | 連線問題 |
| 23 | 臺灣新光商業銀行 | ✅ | ❌ 0/8 | PDF 解析失敗 |
| 24 | 陽信商業銀行 | ✅ | ✅ 8/8 | |
| 25 | 板信商業銀行 | ❌ 網路錯誤 | - | 連線問題 |
| 26 | 三信商業銀行 | ⚠️ 無資料 | - | 僅保留 114 年資料 |
| 27 | 聯邦商業銀行 | ✅ | ❌ 0/8 | PDF Pattern 解析錯誤 |
| 28 | 遠東國際商業銀行 | ⚠️ 無資料 | - | 113Q4 尚無資料 |
| 29 | 元大商業銀行 | ⚠️ 無資料 | - | 113Q4 尚無資料 |
| 30 | 永豐商業銀行 | ✅ | ✅ 8/8 | |
| 31 | 玉山商業銀行 | ✅ | ✅ 8/8 | |
| 32 | 凱基商業銀行 | ✅ | ✅ 8/8 | |
| 33 | 星展(台灣)商業銀行 | ✅ | ❌ 0/8 | PDF 特殊格式 |
| 34 | 台新國際商業銀行 | ⚠️ 無資料 | - | 113Q4 尚無資料 |
| 36 | 安泰商業銀行 | ⚠️ 無資料 | - | 僅保留 114 年資料 |
| 37 | 中國信託商業銀行 | ✅ | ⚠️ 5/8 | 缺少 3 類別 |
| 38 | 樂天國際商業銀行 | ❌ 環境問題 | - | Chromium 路徑問題 |
| 40 | 連線商業銀行 | ✅ | ✅ 8/8 | LINE Bank |
| 41 | 將來商業銀行 | ❌ Timeout | - | 需修復下載器 |

> **註**：代碼 14、35、39 無對應銀行

---

## 113Q4 測試統計

### 下載結果

| 狀態 | 數量 | 百分比 |
|------|------|--------|
| ✅ 成功 | 18 家 | 47% |
| ⚠️ 無資料 | 10 家 | 26% |
| ❌ 錯誤 | 10 家 | 26% |

**成功下載（18 家）**：
合庫、一銀、富邦、輸出入、高雄、兆豐、渣打、匯豐、瑞興、新光、陽信、聯邦、永豐、玉山、凱基、星展、中信、連線

**無資料（10 家）**：
臺銀、土銀、華銀、彰銀、上海、三信、遠東、元大、台新、安泰

**錯誤（10 家）**：
- Timeout：國泰、花旗、王道、台中、將來（5 家）
- 網路錯誤：京城、華泰、板信（3 家）
- 環境問題：中小企銀(wget)、樂天(chromium)（2 家）

### 解析結果（僅下載成功的 18 家）

| 狀態 | 數量 | 百分比 |
|------|------|--------|
| ✅ 完整 (8/8) | 10 家 | 56% |
| ⚠️ 部分成功 | 3 家 | 17% |
| ❌ 失敗 | 5 家 | 28% |

**完整解析（10 家）**：
合庫、一銀、富邦、高雄、匯豐、陽信、永豐、玉山、凱基、連線

**部分解析（3 家）**：
- 輸出入(3/8)：政策性銀行
- 渣打(7/8)：缺少 1 類別
- 中信(5/8)：缺少 3 類別

**解析失敗（5 家）**：
兆豐、瑞興、新光、聯邦、星展

---

## 已知問題與修復記錄

### 已修復問題

#### 1. 企業金融類別解析失敗 (2024-11-29 修復)

**問題描述**：
- 6 家銀行的「企業金融_擔保」、「企業金融_無擔保」無法解析
- 原因：PDF 表格中文字格式為 `企 業\n金 融`（有空格和換行）

**影響銀行**：
- 彰化商業銀行、台北富邦銀行、王道商業銀行
- 聯邦商業銀行、玉山商業銀行、台新國際商業銀行

**解決方案**：
- 新增 `normalize_text()` 函數，移除空格和換行後再比對關鍵字
- 修改位置：`report_generator.py` 及 `utils/text.py`

#### 2. 匯豐(台灣)商業銀行下載失敗 (2024-11-29 修復)

**問題描述**：
- 原下載器無法正確找到 114Q1 財報連結
- 搜尋邏輯使用錯誤的 CSS 選擇器

**解決方案**：
- 修改搜尋邏輯，改為搜尋「{西元年}年{季度}重要財務業務資訊」
- 修改位置：`banks/bank_20_hsbc.py`

#### 3. 多家銀行下載器更新 (2024-11-25 ~ 2024-11-29)

已更新下載器的銀行：
- 02 臺灣土地銀行
- 04 第一商業銀行
- 05 華南商業銀行
- 11 高雄銀行
- 12 兆豐國際商業銀行
- 16 臺灣中小企業銀行
- 18 台中商業銀行
- 23 臺灣新光商業銀行
- 24 陽信商業銀行
- 27 聯邦商業銀行
- 30 永豐商業銀行
- 32 凱基商業銀行
- 33 星展(台灣)商業銀行
- 38 樂天國際商業銀行

### 待處理問題

#### 1. 下載錯誤（需修復下載器）- 10 家

| 代碼 | 銀行 | 錯誤類型 | 說明 |
|------|------|----------|------|
| 09 | 國泰世華商業銀行 | Timeout | 網頁載入逾時 |
| 13 | 花旗（台灣）銀行 | Timeout | 網頁載入逾時 |
| 15 | 王道商業銀行 | Timeout | 網頁載入逾時 |
| 16 | 臺灣中小企業銀行 | 環境問題 | 需要 wget 工具 |
| 18 | 台中商業銀行 | Timeout | 網頁載入逾時 |
| 19 | 京城商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 22 | 華泰商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 25 | 板信商業銀行 | 網路錯誤 | ERR_INTERNET_DISCONNECTED |
| 38 | 樂天國際商業銀行 | 環境問題 | Chromium 路徑問題 |
| 41 | 將來商業銀行 | Timeout | 網頁載入逾時 |

**建議**：
- Timeout 問題：增加 timeout 時間（目前 60 秒），或檢查網站結構是否變更
- 網路錯誤：可能是暫時性網路問題，建議稍後重試
- 環境問題：移除 wget 依賴，統一使用 Playwright；重新安裝 chromium

#### 2. PDF 解析失敗 - 5 家

| 代碼 | 銀行 | 問題 | 建議 |
|------|------|------|------|
| 12 | 兆豐國際商業銀行 | 找不到資產品質頁面 | 分析 PDF 結構 |
| 21 | 瑞興商業銀行 | 掃描式 PDF | 使用 OCR 解析 |
| 23 | 臺灣新光商業銀行 | 找不到資產品質頁面 | 分析 PDF 結構 |
| 27 | 聯邦商業銀行 | PDF Pattern 錯誤 | 處理特殊編碼 |
| 33 | 星展(台灣)商業銀行 | 特殊格式 | 分析 PDF 結構 |

#### 3. 部分解析成功 - 3 家

| 代碼 | 銀行 | 解析結果 | 說明 |
|------|------|----------|------|
| 10 | 中國輸出入銀行 | 3/8 | 政策性銀行，無消費金融 |
| 17 | 渣打國際商業銀行 | 7/8 | 缺少 1 類別 |
| 37 | 中國信託商業銀行 | 5/8 | 缺少 3 類別 |

#### 4. 無資料（非錯誤）- 10 家

這些銀行的 113Q4 資料尚未發布，或網站僅保留近期資料：
- 01 臺灣銀行、02 臺灣土地銀行、05 華南商業銀行、06 彰化商業銀行
- 07 上海商業儲蓄銀行、26 三信商業銀行、28 遠東國際商業銀行
- 29 元大商業銀行、34 台新國際商業銀行、36 安泰商業銀行

**OCR 解析器位置**：`core/ocr_parser.py`

**安裝需求**：
```bash
# macOS
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow
```

---

## 模組結構

```
refactor/
├── core/                    # 核心模組
│   ├── __init__.py
│   ├── models.py            # 資料模型
│   ├── download_manager.py  # 下載管理器
│   ├── report_manager.py    # 報表管理器
│   └── ocr_parser.py        # OCR 解析器（新增）
│
├── banks/                   # 銀行下載器（38 個）
│   ├── base.py              # 基礎類別
│   └── bank_XX_xxx.py       # 各銀行實作
│
├── utils/                   # 工具模組
│   ├── __init__.py
│   ├── text.py              # 文字處理
│   ├── date.py              # 日期處理
│   └── file.py              # 檔案處理
│
├── docs/                    # 文件
│   ├── DOWNLOADER_AUDIT.md  # 下載器盤點報告
│   └── *.md                 # 調查報告
│
├── tests/                   # 測試工具
│   ├── diagnose_failed_banks.py
│   └── test_all.py
│
├── downloader.py            # 下載器主模組
├── report_generator.py      # 報表生成器
├── cli.py                   # 互動式介面
├── main.py                  # 命令列主程式
├── ARCHITECTURE.md          # 架構說明
└── STATUS.md                # 狀態說明（本文件）
```

---

## 測試結果 (114Q1)

### 下載測試

| 項目 | 結果 |
|------|------|
| 測試銀行數 | 38 家 |
| 成功下載 | 38 家 |
| 成功率 | 100% |

### 解析測試

| 項目 | 結果 |
|------|------|
| 一般 PDF 解析 | 36 家 (100%) |
| OCR 解析 | 2 家 (部分成功) |
| 完整解析 (8/8) | 35 家 |
| 部分解析 | 3 家 |

---

## 使用說明

### 快速開始

```bash
# 安裝相依套件
pip install playwright pandas pdfplumber openpyxl
python -m playwright install chromium

# OCR 支援（可選）
brew install tesseract tesseract-lang poppler
pip install pytesseract pdf2image pillow

# 執行互動式介面
cd refactor && python cli.py

# 或使用命令列
python main.py 114Q1
```

### API 使用

```python
from refactor.core import ReportManager, DownloadManager

# 下載
dm = DownloadManager(data_dir='data')
result = dm.download('玉山商業銀行', 114, 1)

# 解析
rm = ReportManager()
df = rm.generate_report('data/114Q1', 'output/report.xlsx')

# OCR 解析（掃描式 PDF）
from refactor.core import OCRParser, is_scanned_pdf

if is_scanned_pdf('path/to/pdf'):
    parser = OCRParser()
    result = parser.parse_pdf('path/to/pdf', '銀行名稱')
```

---

## 更新日誌

| 日期 | 版本 | 變更內容 |
|------|------|----------|
| 2024-11-29 | 2.1 | 新增 OCR 解析器、修復匯豐銀行下載器、新增下載器盤點文件 |
| 2024-11-29 | 2.0 | 重構架構：新增 core/, utils/ 模組 |
| 2024-11-29 | 1.1 | 修復企業金融類別解析問題 |
| 2024-11-25 | 1.0 | 初始 Playwright 版本、更新多家銀行下載器 |
